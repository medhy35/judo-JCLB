<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion des Poules - Judo Manager</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1976d2;
            --secondary-color: #424242;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --light-bg: #fafafa;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Roboto', sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: none;
        }

        .poule-card {
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .poule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .poule-header {
            background: linear-gradient(135deg, var(--primary-color), #42a5f5);
            color: white;
            padding: 1rem;
            font-weight: 500;
        }

        .rencontre-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .rencontre-item:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
        }

        .rencontre-item.prevue {
            border-left: 4px solid #6c757d;
        }

        .rencontre-item.assignee {
            border-left: 4px solid var(--warning-color);
            background-color: #fff8e1;
        }

        .rencontre-item.en_cours {
            border-left: 4px solid var(--primary-color);
            background-color: #e3f2fd;
            animation: pulse 2s infinite;
        }

        .rencontre-item.terminee {
            border-left: 4px solid var(--success-color);
            background-color: #e8f5e8;
        }

        @keyframes pulse {
            0%, 100% { background-color: #e3f2fd; }
            50% { background-color: #bbdefb; }
        }

        .equipe-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .vs-divider {
            font-weight: bold;
            color: var(--secondary-color);
            margin: 0 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn-sm-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .generator-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .generator-card:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .classement-table {
            font-size: 0.9rem;
        }

        .rang-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .rang-1 { background: #ffd700; color: #8b7300; }
        .rang-2 { background: #c0c0c0; color: #4a4a4a; }
        .rang-3 { background: #cd7f32; color: #744210; }
        .rang-other { background: #e9ecef; color: #6c757d; }

        .fab-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary-color), #42a5f5);
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-badge {
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .result-victoire {
            background: #d4edda;
            color: #155724;
        }

        .result-defaite {
            background: #f8d7da;
            color: #721c24;
        }

        .result-egalite {
            background: #fff3cd;
            color: #856404;
        }

        .progress-mini {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-mini-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--primary-color));
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="dashboard_moderne.html">
            <i class="fas fa-arrow-left me-2"></i>Gestion des Poules
        </a>


    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid py-4">
    <!-- Header avec actions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="fw-light mb-1">Gestion des Poules</h2>
            <p class="text-muted">Organisez vos équipes en poules et gérez les rencontres</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-outline-info me-2" id="refreshClassementBtn">
                <i class="fas fa-sync me-2"></i>Actualiser classements
            </button>
            <button class="btn btn-outline-danger me-2" id="resetPoulesBtn">
                <i class="fas fa-trash me-2"></i>Réinitialiser
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGenerateur">
                <i class="fas fa-magic me-2"></i>Générer poules
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number text-primary" id="statPoules">0</div>
            <div class="stat-label">Poules</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-success" id="statRencontres">0</div>
            <div class="stat-label">Rencontres</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-warning" id="statAssignees">0</div>
            <div class="stat-label">Assignées</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-info" id="statTerminees">0</div>
            <div class="stat-label">Terminées</div>
        </div>
    </div>

    <!-- Contenu principal -->
    <div id="mainContent">
        <!-- État vide par défaut -->
        <div id="emptyState" class="generator-card">
            <i class="fas fa-sitemap fa-4x mb-3 text-muted"></i>
            <h4 class="mb-2">Aucune poule générée</h4>
            <p class="text-muted mb-3">Créez des poules pour organiser vos équipes en groupes de compétition</p>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalGenerateur">
                <i class="fas fa-magic me-2"></i>Générer des poules
            </button>
        </div>

        <!-- Contenu des poules -->
        <div id="poulesContent" class="d-none">
            <div class="row" id="poulesContainer"></div>
        </div>
    </div>
</div>

<!-- Bouton FAB -->
<button class="fab-button" onclick="showQuickActions()">
    <i class="fas fa-plus"></i>
</button>

<!-- Modal Générateur de poules -->
<div class="modal fade" id="modalGenerateur" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Générer des poules
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formGenerateur">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nbPoules" class="form-label">Nombre de poules *</label>
                        <input type="number" id="nbPoules" class="form-control" min="1" max="10" value="2" required>
                        <small class="form-text text-muted">Les équipes seront réparties équitablement</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong id="equipesDisponibles">0</strong> équipes disponibles
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="melangealeatoire" checked>
                            <label class="form-check-label" for="melangealeatoire">
                                Mélange aléatoire des équipes
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-magic me-2"></i>Générer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Assignation Tatami -->
<div class="modal fade" id="modalTatami" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play me-2"></i>Assigner à un tatami
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formTatami">
                <div class="modal-body">
                    <input type="hidden" id="rencontreIdToAssign">
                    <div class="mb-3">
                        <label class="form-label">Rencontre sélectionnée</label>
                        <div id="rencontreInfo" class="p-2 bg-light rounded">
                            <!-- Info dynamique -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tatamiSelect" class="form-label">Tatami disponible *</label>
                        <select class="form-select" id="tatamiSelect" required>
                            <option value="">-- Choisir un tatami --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Assigner
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Détails Rencontre -->
<div class="modal fade" id="modalDetailsRencontre" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Détails de la rencontre
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsRencontreContent">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // Variables globales

    let poules = [];
    let equipes = [];
    let tatamis = [];
    let combats = [];
    let selectedRencontreId = null;

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
        setupEventListeners();
        setupAutoRefresh();
    });

    // Chargement des données
    async function loadData() {
        try {
            const [poulesData, equipesData, tatamisData, combatsData] = await Promise.all([
                fetch('/api/poules').then(r => r.json()),
                fetch('/api/equipes').then(r => r.json()),
                fetch('/api/tatamis').then(r => r.json()),
                fetch('/api/combats').then(r => r.json())
            ]);

            poules = poulesData;
            equipes = equipesData;
            tatamis = tatamisData;
            combats = combatsData;

            renderPoules();
            updateStats();
            updateEquipesInfo();
            updateTatamisSelect();
        } catch (error) {
            console.error('Erreur chargement:', error);
            showNotification('Erreur de chargement des données', 'danger');
        }
    }

    // Rendu des poules
    function renderPoules() {
        const emptyState = document.getElementById('emptyState');
        const poulesContent = document.getElementById('poulesContent');
        const container = document.getElementById('poulesContainer');

        if (poules.length === 0) {
            emptyState.classList.remove('d-none');
            poulesContent.classList.add('d-none');
            return;
        }

        emptyState.classList.add('d-none');
        poulesContent.classList.remove('d-none');

        const html = poules.map(poule => createPouleCard(poule)).join('');
        container.innerHTML = html;
    }

    // Création d'une carte de poule
    function createPouleCard(poule) {
        const equipesPoule = poule.equipesIds.map(id =>
            equipes.find(e => e.id === id) || { id, nom: id, couleur: 'secondary' }
        );

        const totalRencontres = poule.rencontres.length;
        const rencontresTerminees = poule.rencontres.filter(r => isRencontreTerminee(r)).length;
        const progression = totalRencontres > 0 ? (rencontresTerminees / totalRencontres) * 100 : 0;

        return `
                <div class="col-lg-6 mb-4">
                    <div class="card poule-card">
                        <div class="poule-header">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">${poule.nom}</h5>
                                <span class="badge bg-white bg-opacity-25">
                                    ${poule.rencontres.length} rencontres
                                </span>
                            </div>
                            <div class="progress-mini">
                                <div class="progress-mini-bar" style="width: ${progression}%"></div>
                            </div>
                            <small class="text-white opacity-75 mt-1">
                                ${rencontresTerminees}/${totalRencontres} terminées
                            </small>
                        </div>

                        <div class="card-body">
                            <!-- Équipes -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-users me-1"></i>Équipes (${equipesPoule.length})
                                </h6>
                                <div class="d-flex flex-wrap gap-1">
                                    ${equipesPoule.map(equipe =>
            `<span class="equipe-badge bg-${equipe.couleur} text-white">${equipe.nom}</span>`
        ).join('')}
                                </div>
                            </div>

                            <!-- Rencontres -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-handshake me-1"></i>Rencontres
                                </h6>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${poule.rencontres.length === 0 ?
            '<p class="text-muted mb-0">Aucune rencontre</p>' :
            poule.rencontres.map(rencontre => createRencontreItem(rencontre, poule.id)).join('')
        }
                                </div>
                            </div>

                            <!-- Classement -->
                            ${poule.classement && poule.classement.length > 0 ? `
                                <div>
                                    <h6 class="text-muted mb-2">
                                        <i class="fas fa-trophy me-1"></i>Classement
                                    </h6>
                                    <div class="classement-table">
                                        ${poule.classement.slice(0, 5).map((item, index) => {
            const equipe = equipes.find(e => e.id === item.equipeId);
            const rangClass = index === 0 ? 'rang-1' :
                index === 1 ? 'rang-2' :
                    index === 2 ? 'rang-3' : 'rang-other';
            return `
                                                <div class="d-flex align-items-center justify-content-between mb-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="rang-badge ${rangClass} me-2">${index + 1}</span>
                                                        <span class="small">${equipe ? equipe.nom : item.equipeId}</span>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="fw-bold text-primary">${item.points}</span>
                                                        <small class="text-muted">pts</small>
                                                    </div>
                                                </div>
                                            `;
        }).join('')}
                                        ${poule.classement.length > 5 ? `
                                            <div class="text-center mt-2">
                                                <button class="btn btn-sm btn-outline-primary" onclick="voirClassementComplet(${poule.id})">
                                                    <i class="fas fa-eye me-1"></i>Voir tout (${poule.classement.length})
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : `
                                <div class="text-center py-3">
                                    <i class="fas fa-trophy fa-2x text-muted mb-2"></i>
                                    <p class="text-muted mb-0 small">Classement disponible après les combats</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
    }

    // Création d'un item de rencontre
    function createRencontreItem(rencontre, pouleId) {
        const equipeA = equipes.find(e => e.id === rencontre.equipeA) || { nom: rencontre.equipeA, couleur: 'secondary' };
        const equipeB = equipes.find(e => e.id === rencontre.equipeB) || { nom: rencontre.equipeB, couleur: 'secondary' };

        // Déterminer l'état de la rencontre
        const etat = determinerEtatRencontre(rencontre);
        const etatLabels = {
            prevue: 'Prévue',
            assignee: 'Assignée',
            en_cours: 'En cours',
            terminee: 'Terminée'
        };

        // Calculer le résultat si terminée
        let resultatHtml = '';
        if (etat === 'terminee' && rencontre.combatsIds) {
            const resultat = calculerResultatRencontre(rencontre);
            if (resultat) {
                resultatHtml = `
                        <div class="mt-1">
                            <span class="result-badge ${resultat.vainqueur === 'A' ? 'result-victoire' : 'result-defaite'}">
                                ${resultat.scoreA}
                            </span>
                            <span class="mx-1">-</span>
                            <span class="result-badge ${resultat.vainqueur === 'B' ? 'result-victoire' : 'result-defaite'}">
                                ${resultat.scoreB}
                            </span>
                        </div>
                    `;
            }
        }

        return `
                <div class="rencontre-item ${etat}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <span class="fw-medium">${equipeA.nom}</span>
                                <span class="vs-divider">vs</span>
                                <span class="fw-medium">${equipeB.nom}</span>
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <small class="text-muted">
                                    <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>
                                    ${etatLabels[etat]}
                                    ${rencontre.combatsIds && rencontre.combatsIds.length > 0 ?
            ` • ${rencontre.combatsIds.length} combat(s)` : ''}
                                </small>
                                ${resultatHtml}
                            </div>
                        </div>

                        <div class="action-buttons">
                            ${etat === 'prevue' ? `
                                <button class="btn btn-outline-primary btn-sm-icon"
                                        onclick="assignerRencontre(${rencontre.id})"
                                        title="Assigner à un tatami">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : ''}

                            <button class="btn btn-outline-info btn-sm-icon"
                                    onclick="voirDetailsRencontre(${rencontre.id})"
                                    title="Voir détails">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
    }

    // Déterminer l'état d'une rencontre
    function determinerEtatRencontre(rencontre) {
        if (!rencontre.combatsIds || rencontre.combatsIds.length === 0) {
            return 'prevue';
        }

        const combatsRencontre = rencontre.combatsIds.map(id =>
            combats.find(c => c.id === id)
        ).filter(Boolean);

        if (combatsRencontre.length === 0) return 'assignee';

        const combatsEnCours = combatsRencontre.some(c => c.etat === 'en cours');
        const combatsTermines = combatsRencontre.filter(c => c.etat === 'terminé').length;

        if (combatsEnCours) return 'en_cours';
        if (combatsTermines === combatsRencontre.length) return 'terminee';

        return 'assignee';
    }

    // Vérifier si une rencontre est terminée
    function isRencontreTerminee(rencontre) {
        return determinerEtatRencontre(rencontre) === 'terminee';
    }

    // Calculer le résultat d'une rencontre
    function calculerResultatRencontre(rencontre) {
        if (!rencontre.combatsIds || rencontre.combatsIds.length === 0) return null;

        const combatsRencontre = rencontre.combatsIds.map(id =>
            combats.find(c => c.id === id)
        ).filter(c => c && c.etat === 'terminé');

        if (combatsRencontre.length === 0) return null;

        let victoiresA = 0;
        let victoiresB = 0;

        combatsRencontre.forEach(combat => {
            // Déterminer quelle équipe correspond à A ou B dans ce combat
            const equipeRougeId = combat.rouge?.equipeId || combat.rouge?.id;
            const equipeBleuId = combat.bleu?.equipeId || combat.bleu?.id;

            let estRougeEquipeA;
            if (equipeRougeId === rencontre.equipeA) {
                estRougeEquipeA = true;
            } else if (equipeRougeId === rencontre.equipeB) {
                estRougeEquipeA = false;
            } else {
                return; // Combat ne concerne pas cette rencontre
            }

            // Déterminer le vainqueur
            const vainqueur = determinerVainqueurCombat(combat);
            if (vainqueur === 'rouge') {
                if (estRougeEquipeA) victoiresA++;
                else victoiresB++;
            } else if (vainqueur === 'bleu') {
                if (estRougeEquipeA) victoiresB++;
                else victoiresA++;
            }
        });

        return {
            scoreA: victoiresA,
            scoreB: victoiresB,
            vainqueur: victoiresA > victoiresB ? 'A' :
                victoiresB > victoiresA ? 'B' : null
        };
    }

    // Déterminer le vainqueur d'un combat
    function determinerVainqueurCombat(combat) {
        if (combat.etat !== 'terminé') return null;

        // Ippon
        if (combat.ipponRouge) return 'rouge';
        if (combat.ipponBleu) return 'bleu';

        // Double wazari
        if ((combat.wazariRouge || 0) >= 2) return 'rouge';
        if ((combat.wazariBleu || 0) >= 2) return 'bleu';

        // Disqualification par shido
        if ((combat.penalitesBleu || 0) >= 3) return 'rouge';
        if ((combat.penalitesRouge || 0) >= 3) return 'bleu';

        // Avantage par wazari
        const wazariRouge = combat.wazariRouge || 0;
        const wazariBleu = combat.wazariBleu || 0;
        if (wazariRouge > wazariBleu) return 'rouge';
        if (wazariBleu > wazariRouge) return 'bleu';

        // Avantage par yuko
        const yukoRouge = combat.yukoRouge || 0;
        const yukoBleu = combat.yukoBleu || 0;
        if (yukoRouge > yukoBleu) return 'rouge';
        if (yukoBleu > yukoRouge) return 'bleu';

        return null; // Égalité
    }

    // Mise à jour des statistiques
    function updateStats() {
        const totalRencontres = poules.reduce((sum, p) => sum + p.rencontres.length, 0);
        const assignees = poules.reduce((sum, p) =>
            sum + p.rencontres.filter(r => ['assignee', 'en_cours'].includes(determinerEtatRencontre(r))).length, 0);
        const terminees = poules.reduce((sum, p) =>
            sum + p.rencontres.filter(r => determinerEtatRencontre(r) === 'terminee').length, 0);

        document.getElementById('statPoules').textContent = poules.length;
        document.getElementById('statRencontres').textContent = totalRencontres;
        document.getElementById('statAssignees').textContent = assignees;
        document.getElementById('statTerminees').textContent = terminees;
    }

    // Mise à jour des infos équipes
    function updateEquipesInfo() {
        document.getElementById('equipesDisponibles').textContent = equipes.length;
    }

    // Mise à jour de la sélection tatamis
    function updateTatamisSelect() {
        const select = document.getElementById('tatamiSelect');
        select.innerHTML = '<option value="">-- Choisir un tatami --</option>';

        tatamis.filter(t => t.etat === 'libre').forEach(tatami => {
            const option = document.createElement('option');
            option.value = tatami.id;
            option.textContent = `${tatami.nom} (libre)`;
            select.appendChild(option);
        });

        if (tatamis.filter(t => t.etat === 'libre').length === 0) {
            const option = document.createElement('option');
            option.textContent = 'Aucun tatami libre disponible';
            option.disabled = true;
            select.appendChild(option);
        }
    }

    // Configuration des événements
    function setupEventListeners() {
        // Génération de poules
        document.getElementById('formGenerateur').addEventListener('submit', handleGenerateurSubmit);

        // Assignation tatami
        document.getElementById('formTatami').addEventListener('submit', handleTatamiSubmit);

        // Reset poules
        document.getElementById('resetPoulesBtn').addEventListener('click', handleResetPoules);

        // Refresh classements
        document.getElementById('refreshClassementBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/classement/general');
                showNotification('Classements actualisés', 'success');
                loadData();
            } catch (error) {
                showNotification('Erreur lors de l\'actualisation', 'danger');
            }
        });
    }

    // Génération des poules
    async function handleGenerateurSubmit(e) {
        e.preventDefault();

        const nbPoules = parseInt(document.getElementById('nbPoules').value);

        if (equipes.length < nbPoules) {
            showNotification(`Il faut au moins ${nbPoules} équipes pour créer ${nbPoules} poules`, 'warning');
            return;
        }

        if (poules.length > 0) {
            if (!confirm('Des poules existent déjà. Les remplacer ?')) {
                return;
            }
        }

        try {
            const response = await fetch('/api/poules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nbPoules })
            });

            if (response.ok) {
                const result = await response.json();
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalGenerateur'));
                modal.hide();

                showNotification(`${result.length || nbPoules} poules générées avec succès`, 'success');
                loadData();
            } else {
                const error = await response.json();
                showNotification(error.error || 'Erreur lors de la génération', 'danger');
            }
        } catch (error) {
            console.error('Erreur génération:', error);
            showNotification('Erreur de connexion', 'danger');
        }
    }

    // Assignation à un tatami
    function assignerRencontre(rencontreId) {
        selectedRencontreId = rencontreId;

        // Trouver la rencontre
        let rencontre = null;
        for (const poule of poules) {
            rencontre = poule.rencontres.find(r => r.id === rencontreId);
            if (rencontre) break;
        }

        if (!rencontre) return;

        // Mettre à jour les infos dans le modal
        const equipeA = equipes.find(e => e.id === rencontre.equipeA) || { nom: rencontre.equipeA };
        const equipeB = equipes.find(e => e.id === rencontre.equipeB) || { nom: rencontre.equipeB };

        document.getElementById('rencontreIdToAssign').value = rencontreId;
        document.getElementById('rencontreInfo').innerHTML = `
                <div class="d-flex align-items-center justify-content-center">
                    <span class="fw-bold text-primary">${equipeA.nom}</span>
                    <span class="mx-3 text-muted">vs</span>
                    <span class="fw-bold text-danger">${equipeB.nom}</span>
                </div>
            `;

        updateTatamisSelect();

        const modal = new bootstrap.Modal(document.getElementById('modalTatami'));
        modal.show();
    }

    // Soumission assignation tatami
    async function handleTatamiSubmit(e) {
        e.preventDefault();

        const rencontreId = parseInt(document.getElementById('rencontreIdToAssign').value);
        const tatamiId = parseInt(document.getElementById('tatamiSelect').value);

        if (!tatamiId) {
            showNotification('Veuillez sélectionner un tatami', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/poules/assign-combat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rencontreId, tatamiId })
            });

            if (response.ok) {
                const result = await response.json();
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalTatami'));
                modal.hide();

                showNotification(`Rencontre assignée ! ${result.combatsCrees} combat(s) créé(s)`, 'success');
                loadData();
            } else {
                const error = await response.json();
                showNotification(error.error || 'Erreur lors de l\'assignation', 'danger');
            }
        } catch (error) {
            console.error('Erreur assignation:', error);
            showNotification('Erreur de connexion', 'danger');
        }
    }

    // Reset des poules
    async function handleResetPoules() {
        if (!confirm('Supprimer toutes les poules ? Cette action est irréversible.')) {
            return;
        }

        try {
            const response = await fetch('/api/poules', {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Poules supprimées', 'success');
                loadData();
            } else {
                showNotification('Erreur lors de la suppression', 'danger');
            }
        } catch (error) {
            showNotification('Erreur de connexion', 'danger');
        }
    }

    // Voir détails d'une rencontre
    async function voirDetailsRencontre(rencontreId) {
        // Trouver la rencontre
        let rencontre = null;
        let pouleParent = null;
        for (const poule of poules) {
            rencontre = poule.rencontres.find(r => r.id === rencontreId);
            if (rencontre) {
                pouleParent = poule;
                break;
            }
        }

        if (!rencontre) return;

        const equipeA = equipes.find(e => e.id === rencontre.equipeA) || { nom: rencontre.equipeA, couleur: 'secondary' };
        const equipeB = equipes.find(e => e.id === rencontre.equipeB) || { nom: rencontre.equipeB, couleur: 'secondary' };
        const etat = determinerEtatRencontre(rencontre);

        // Récupérer les combats de cette rencontre
        const combatsRencontre = rencontre.combatsIds ?
            rencontre.combatsIds.map(id => combats.find(c => c.id === id)).filter(Boolean) : [];

        let content = `
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <h4 class="mb-3">
                            <span class="badge bg-${equipeA.couleur} me-2">${equipeA.nom}</span>
                            <span class="text-muted">vs</span>
                            <span class="badge bg-${equipeB.couleur} ms-2">${equipeB.nom}</span>
                        </h4>
                        <p class="text-muted mb-1">Poule: ${pouleParent.nom}</p>
                        <span class="badge bg-${etat === 'terminee' ? 'success' : etat === 'en_cours' ? 'primary' : etat === 'assignee' ? 'warning' : 'secondary'}">
                            ${etat === 'prevue' ? 'Prévue' :
            etat === 'assignee' ? 'Assignée' :
                etat === 'en_cours' ? 'En cours' : 'Terminée'}
                        </span>
                    </div>
                </div>
            `;

        if (combatsRencontre.length === 0) {
            content += `
                    <div class="text-center py-4">
                        <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Aucun combat généré pour cette rencontre</p>
                    </div>
                `;
        } else {
            content += `
                    <h6 class="mb-3">
                        <i class="fas fa-fist-raised me-2"></i>Combats (${combatsRencontre.length})
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Combat</th>
                                    <th>État</th>
                                    <th>Score</th>
                                    <th>Vainqueur</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${combatsRencontre.map((combat, index) => {
                const vainqueur = determinerVainqueurCombat(combat);
                const vainqueurNom = vainqueur === 'rouge' ? combat.rouge?.nom :
                    vainqueur === 'bleu' ? combat.bleu?.nom : null;

                return `
                                        <tr>
                                            <td>
                                                <small class="text-muted">#${index + 1}</small><br>
                                                <strong class="text-danger">${combat.rouge?.nom || 'Rouge'}</strong> vs
                                                <strong class="text-primary">${combat.bleu?.nom || 'Bleu'}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-${combat.etat === 'terminé' ? 'success' : combat.etat === 'en cours' ? 'primary' : 'secondary'}">
                                                    ${combat.etat}
                                                </span>
                                            </td>
                                            <td>
                                                ${combat.etat === 'terminé' ? `
                                                    <div class="d-flex gap-1">
                                                        ${combat.ipponRouge ? '<span class="badge bg-warning">I</span>' : ''}
                                                        ${combat.wazariRouge > 0 ? `<span class="badge bg-info">${combat.wazariRouge}W</span>` : ''}
                                                        ${combat.yukoRouge > 0 ? `<span class="badge bg-secondary">${combat.yukoRouge}Y</span>` : ''}
                                                    </div>
                                                    <small class="text-muted">vs</small>
                                                    <div class="d-flex gap-1 mt-1">
                                                        ${combat.ipponBleu ? '<span class="badge bg-warning">I</span>' : ''}
                                                        ${combat.wazariBleu > 0 ? `<span class="badge bg-info">${combat.wazariBleu}W</span>` : ''}
                                                        ${combat.yukoBleu > 0 ? `<span class="badge bg-secondary">${combat.yukoBleu}Y</span>` : ''}
                                                    </div>
                                                ` : '<span class="text-muted">-</span>'}
                                            </td>
                                            <td>
                                                ${vainqueurNom ?
                    `<strong class="text-success">${vainqueurNom}</strong>` :
                    '<span class="text-muted">-</span>'
                }
                                            </td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            // Résultat global de la rencontre si terminée
            if (etat === 'terminee') {
                const resultat = calculerResultatRencontre(rencontre);
                if (resultat) {
                    content += `
                            <div class="alert alert-info mt-3">
                                <h6 class="mb-2"><i class="fas fa-trophy me-2"></i>Résultat final</h6>
                                <div class="text-center">
                                    <span class="badge bg-${resultat.vainqueur === 'A' ? 'success' : 'secondary'} fs-6 me-2">
                                        ${equipeA.nom}: ${resultat.scoreA}
                                    </span>
                                    <span class="text-muted">-</span>
                                    <span class="badge bg-${resultat.vainqueur === 'B' ? 'success' : 'secondary'} fs-6 ms-2">
                                        ${equipeB.nom}: ${resultat.scoreB}
                                    </span>
                                </div>
                                ${resultat.vainqueur ?
                        `<p class="text-center mt-2 mb-0">
                                        <i class="fas fa-crown text-warning me-1"></i>
                                        <strong>${resultat.vainqueur === 'A' ? equipeA.nom : equipeB.nom} remporte la rencontre</strong>
                                    </p>` : ''
                    }
                            </div>
                        `;
                }
            }
        }

        document.getElementById('detailsRencontreContent').innerHTML = content;
        const modal = new bootstrap.Modal(document.getElementById('modalDetailsRencontre'));
        modal.show();
    }

    // Voir classement complet d'une poule
    function voirClassementComplet(pouleId) {
        const poule = poules.find(p => p.id === pouleId);
        if (!poule || !poule.classement) return;

        showNotification('Redirection vers le classement complet', 'info');
        // TODO: Implémenter la page de classement détaillé
    }

    // Actions rapides FAB
    function showQuickActions() {
        if (poules.length === 0) {
            const modal = new bootstrap.Modal(document.getElementById('modalGenerateur'));
            modal.show();
        } else {
            // Chercher une rencontre prête à être assignée
            let rencontrePrete = null;
            for (const poule of poules) {
                rencontrePrete = poule.rencontres.find(r => determinerEtatRencontre(r) === 'prevue');
                if (rencontrePrete) break;
            }

            if (rencontrePrete) {
                assignerRencontre(rencontrePrete.id);
            } else {
                showNotification('Aucune rencontre à assigner', 'info');
            }
        }
    }

    // WebSocket
    function setupAutoRefresh() {
        // Refresh automatique toutes les 4 secondes
        // 4s car page complexe avec beaucoup de calculs
        setInterval(() => {
            loadData();
        }, 4000);
    }

    // Notifications
    function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 2000; min-width: 300px;';
        toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }

    // Reset des modals
    document.getElementById('modalGenerateur').addEventListener('hidden.bs.modal', function() {
        document.getElementById('formGenerateur').reset();
        document.getElementById('nbPoules').value = 2;
    });

    document.getElementById('modalTatami').addEventListener('hidden.bs.modal', function() {
        document.getElementById('formTatami').reset();
        selectedRencontreId = null;
    });
</script>
</body>
</html>