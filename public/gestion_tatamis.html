<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestion des Tatamis - Judo Manager</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1976d2;
            --secondary-color: #424242;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --light-bg: #fafafa;
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Roboto', sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: none;
        }

        .tatami-card {
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            overflow: hidden;
            position: relative;
        }

        .tatami-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .tatami-card.libre {
            border-left: 4px solid var(--success-color);
        }

        .tatami-card.occupe {
            border-left: 4px solid var(--danger-color);
        }

        .tatami-card.pause {
            border-left: 4px solid var(--warning-color);
        }

        .tatami-header {
            background: linear-gradient(135deg, var(--secondary-color), #616161);
            color: white;
            padding: 1rem;
            font-weight: 500;
        }

        .tatami-header.libre {
            background: linear-gradient(135deg, var(--success-color), #66bb6a);
        }

        .tatami-header.occupe {
            background: linear-gradient(135deg, var(--danger-color), #ef5350);
        }

        .tatami-header.pause {
            background: linear-gradient(135deg, var(--warning-color), #ffa726);
        }

        .combat-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .combat-actuel {
            border: 2px solid var(--primary-color);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .vs-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 0 0.5rem;
        }

        .score-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.1rem;
        }

        .score-rouge {
            background: #ffebee;
            color: #c62828;
        }

        .score-bleu {
            background: #e3f2fd;
            color: #1565c0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .generator-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .generator-card:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn-sm-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .progress-mini {
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-mini-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            transition: width 0.3s ease;
        }

        .combat-queue {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .combat-queue-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85rem;
        }

        .combat-queue-item:last-child {
            border-bottom: none;
        }

        .combat-queue-item.current {
            background: #e3f2fd;
            font-weight: 500;
        }

        .fab-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary-color), #42a5f5);
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.libre {
            background: var(--success-color);
        }

        .status-indicator.occupe {
            background: var(--danger-color);
        }

        .status-indicator.pause {
            background: var(--warning-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .score-display {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin: 1rem 0;
        }

        .combattant-info {
            text-align: center;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .combattant-rouge {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .combattant-bleu {
            background: rgba(25, 118, 210, 0.1);
            border: 1px solid rgba(25, 118, 210, 0.3);
        }

        .confrontation-score {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 1px solid #ffcc02;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .quick-stat {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .quick-stat-number {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.2rem;
        }

        .quick-stat-label {
            color: #6c757d;
            font-size: 0.75rem;
        }
    </style>
</head>

<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="index.html">
            <i class="fas fa-arrow-left me-2"></i>Gestion des Tatamis
        </a>


        </div>
</nav>

<!-- Main Content -->
<div class="container-fluid py-4">
    <!-- Header avec actions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="fw-light mb-1">Gestion des Tatamis</h2>
            <p class="text-muted">Contr√¥lez vos tatamis et leurs combats en temps r√©el</p>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-outline-info me-2" id="refreshBtn">
                <i class="fas fa-sync me-2"></i>Actualiser
            </button>
            <button class="btn btn-outline-warning me-2" id="pauseAllBtn">
                <i class="fas fa-pause me-2"></i>Pause g√©n√©rale
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTatami">
                <i class="fas fa-plus me-2"></i>Nouveau tatami
            </button>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number text-primary" id="statTatamis">0</div>
            <div class="stat-label">Tatamis</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-success" id="statLibres">0</div>
            <div class="stat-label">Libres</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-danger" id="statOccupes">0</div>
            <div class="stat-label">Occup√©s</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-warning" id="statEnPause">0</div>
            <div class="stat-label">En pause</div>
        </div>
    </div>

    <!-- Contenu principal -->
    <div id="mainContent">
        <!-- √âtat vide par d√©faut -->
        <div id="emptyState" class="generator-card">
            <i class="fas fa-th-large fa-4x mb-3 text-muted"></i>
            <h4 class="mb-2">Aucun tatami configur√©</h4>
            <p class="text-muted mb-3">Cr√©ez des tatamis pour organiser vos combats</p>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalTatami">
                <i class="fas fa-plus me-2"></i>Cr√©er le premier tatami
            </button>
        </div>

        <!-- Contenu des tatamis -->
        <div id="tatamisContent" class="d-none">
            <div class="row" id="tatamisContainer"></div>
        </div>
    </div>
</div>

<!-- Bouton FAB -->
<button class="fab-button" onclick="showQuickActions()">
    <i class="fas fa-plus"></i>
</button>

<!-- Modal Nouveau Tatami -->
<div class="modal fade" id="modalTatami" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTatamiTitle">
                    <i class="fas fa-th-large me-2"></i>Nouveau tatami
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formTatami">
                <div class="modal-body">
                    <input type="hidden" id="tatamiEditId">
                    <div class="mb-3">
                        <label for="tatamiNom" class="form-label">Nom du tatami *</label>
                        <input type="text" id="tatamiNom" class="form-control" required
                               placeholder="Ex: Tatami Principal">
                    </div>
                    <div class="mb-3">
                        <label for="tatamiDescription" class="form-label">Description</label>
                        <textarea id="tatamiDescription" class="form-control" rows="2"
                                  placeholder="Description optionnelle..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Contr√¥le Tatami -->
<div class="modal fade" id="modalControle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gamepad me-2"></i>Contr√¥le du tatami
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="controleContent">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Assignation Combats -->
<div class="modal fade" id="modalAssignation" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Assigner des combats
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formAssignation">
                <div class="modal-body">
                    <input type="hidden" id="assignTatamiId">
                    <div class="mb-3">
                        <label class="form-label">Tatami s√©lectionn√©</label>
                        <div id="assignTatamiInfo" class="p-2 bg-light rounded">
                            <!-- Info dynamique -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Source des combats</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sourceType" id="sourcePoule" value="poule" checked>
                            <label class="form-check-label" for="sourcePoule">
                                Rencontre de poule
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="sourceType" id="sourceCombat" value="combat">
                            <label class="form-check-label" for="sourceCombat">
                                Combats individuels
                            </label>
                        </div>
                    </div>

                    <div id="sectionPoule">
                        <div class="mb-3">
                            <label for="rencontreSelect" class="form-label">Rencontre √† assigner</label>
                            <select class="form-select" id="rencontreSelect">
                                <option value="">-- Choisir une rencontre --</option>
                            </select>
                        </div>
                    </div>

                    <div id="sectionCombat" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">Combats disponibles</label>
                            <div id="combatsDisponibles" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                <!-- Liste des combats -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Assigner
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Variables globales

    let tatamis = [];
    let combats = [];
    let poules = [];
    let selectedTatamiId = null;
    let CONFIG = null;

    // Initialisation
    document.addEventListener('DOMContentLoaded', async function() {
        await loadConfig();
        await loadData();
        setupEventListeners();
        setupAutoRefresh();
    });

    async function loadConfig() {
        try {
            CONFIG = await fetch('/api/config').then(r => r.json());
            console.log('‚úÖ Config charg√©e:', CONFIG);
        } catch (error) {
            console.error('‚ùå Erreur chargement config:', error);
            CONFIG = {
                combat: {
                    dureeParDefaut: 240
                },
                display: {
                    notificationDuration: 3000,
                    maxCombatsQueue: 5
                },
                tatamis: {
                    nombreMax: 10
                }
            };
        }
    }


    // Chargement des donn√©es
    async function loadData() {
        try {
            const [tatamisData, combatsData, poulesData] = await Promise.all([
                fetch('/api/tatamis').then(r => r.json()),
                fetch('/api/combats').then(r => r.json()),
                fetch('/api/poules').then(r => r.json())
            ]);
            console.log('üì¶ [DEBUG] tatamisData re√ßu:', tatamisData);

            tatamis = tatamisData;
            combats = combatsData;
            poules = poulesData;

            renderTatamis();
            updateStats();
            updateRencontresSelect();
            updateCombatsDisponibles();
        } catch (error) {
            console.error('Erreur chargement:', error);
            showNotification('Erreur de chargement des donn√©es', 'danger');
        }
    }

    // Rendu des tatamis
    function renderTatamis() {
        const emptyState = document.getElementById('emptyState');
        const tatamisContent = document.getElementById('tatamisContent');
        const container = document.getElementById('tatamisContainer');

        if (tatamis.length === 0) {
            emptyState.classList.remove('d-none');
            tatamisContent.classList.add('d-none');
            return;
        }

        emptyState.classList.add('d-none');
        tatamisContent.classList.remove('d-none');

        const html = tatamis.map(tatami => createTatamiCard(tatami)).join('');
        container.innerHTML = html;
    }

    // Cr√©ation d'une carte de tatami
    function createTatamiCard(tatami) {
        const etat = tatami.etat || 'libre';
        const combatActuel = getCombatActuel(tatami);
        const progression = calculateProgression(tatami);
        const stats = getTatamiStats(tatami);

        return `
                <div class="col-lg-6 mb-4">
                    <div class="card tatami-card ${etat}">
                        <div class="status-indicator ${etat}"></div>

                        <div class="tatami-header ${etat}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">${tatami.nom}</h5>
                                <span class="badge bg-white bg-opacity-25">
                                    ${etat === 'libre' ? 'Libre' :
            etat === 'occup√©' ? 'En cours' : 'En pause'}
                                </span>
                            </div>

                            ${tatami.combatsIds && tatami.combatsIds.length > 0 ? `
                                <div class="progress-mini mb-2">
                                    <div class="progress-mini-bar" style="width: ${progression}%"></div>
                                </div>
                                <small class="text-white opacity-75">
                                    ${(tatami.indexCombatActuel || 0) + 1}/${tatami.combatsIds.length} combats
                                </small>
                            ` : ''}
                        </div>

                        <div class="card-body">
                            ${combatActuel ? `
                                <!-- Combat actuel -->
                                <div class="combat-info combat-actuel mb-3">
                                    <div class="score-display">
                                        <div class="combattant-info combattant-rouge">
                                            <div class="fw-bold text-danger">${combatActuel.rouge?.nom || 'Rouge'}</div>
                                            <small class="text-muted">${combatActuel.rouge?.equipe || 'N/A'}</small>
                                            <div class="mt-1">
                                                ${combatActuel.ipponRouge ? '<span class="score-badge score-rouge">IPPON</span>' : ''}
                                                ${combatActuel.wazariRouge > 0 ? `<span class="score-badge score-rouge">${combatActuel.wazariRouge}W</span>` : ''}
                                                ${combatActuel.yukoRouge > 0 ? `<span class="score-badge score-rouge">${combatActuel.yukoRouge}Y</span>` : ''}
                                                ${combatActuel.penalitesRouge > 0 ? `<span class="score-badge score-rouge">${combatActuel.penalitesRouge}S</span>` : ''}
                                            </div>
                                        </div>

                                        <div class="vs-divider">
                                            <i class="fas fa-bolt fa-2x text-warning"></i>
                                        </div>

                                        <div class="combattant-info combattant-bleu">
                                            <div class="fw-bold text-primary">${combatActuel.bleu?.nom || 'Bleu'}</div>
                                            <small class="text-muted">${combatActuel.bleu?.equipe || 'N/A'}</small>
                                            <div class="mt-1">
                                                ${combatActuel.ipponBleu ? '<span class="score-badge score-bleu">IPPON</span>' : ''}
                                                ${combatActuel.wazariBleu > 0 ? `<span class="score-badge score-bleu">${combatActuel.wazariBleu}W</span>` : ''}
                                                ${combatActuel.yukoBleu > 0 ? `<span class="score-badge score-bleu">${combatActuel.yukoBleu}Y</span>` : ''}
                                                ${combatActuel.penalitesBleu > 0 ? `<span class="score-badge score-bleu">${combatActuel.penalitesBleu}S</span>` : ''}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="timer-display">
                                        <i class="fas fa-clock me-2"></i>
                                        ${formatTimer(combatActuel.timer || CONFIG?.combat?.dureeParDefaut || 240)}
                                    </div>

                                    <div class="text-center mt-2">
                                        <span class="badge bg-${combatActuel.etat === 'en cours' ? 'success' : combatActuel.etat === 'termin√©' ? 'secondary' : 'warning'}">
                                            ${combatActuel.etat === 'en cours' ? 'EN COURS' :
            combatActuel.etat === 'termin√©' ? 'TERMIN√â' : '√Ä VENIR'}
                                        </span>
                                    </div>
                                </div>

                                <!-- Score de confrontation √©quipes -->
                                ${tatami.scoreConfrontation ? `
                                    <div class="confrontation-score">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="text-center">
                                                <div class="fw-bold text-danger fs-4">${tatami.scoreConfrontation.rouge || 0}</div>
                                                <small class="text-muted">Points √©quipe rouge</small>
                                            </div>
                                            <div class="text-center">
                                                <i class="fas fa-trophy text-warning fa-2x"></i>
                                            </div>
                                            <div class="text-center">
                                                <div class="fw-bold text-primary fs-4">${tatami.scoreConfrontation.bleu || 0}</div>
                                                <small class="text-muted">Points √©quipe bleue</small>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- File d'attente des combats -->
                                ${tatami.combatsIds && tatami.combatsIds.length > 1 ? `
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-2">
                                            <i class="fas fa-list me-1"></i>Prochains combats
                                        </h6>
                                        <div class="combat-queue">
                                            ${generateCombatQueue(tatami).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            ` : `
                                <!-- Tatami libre -->
                                <div class="empty-state">
                                    <i class="fas fa-bed fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-3">Tatami libre</p>
                                    <button class="btn btn-primary btn-sm" onclick="assignerCombats(${tatami.id})">
                                        <i class="fas fa-plus me-1"></i>Assigner des combats
                                    </button>
                                </div>
                            `}

                            <!-- Statistiques rapides -->
                            <div class="quick-stats">
                                <div class="quick-stat">
                                    <div class="quick-stat-number text-success">${stats.termines}</div>
                                    <div class="quick-stat-label">Termin√©s</div>
                                </div>
                                <div class="quick-stat">
                                    <div class="quick-stat-number text-warning">${stats.restants}</div>
                                    <div class="quick-stat-label">Restants</div>
                                </div>
                                <div class="quick-stat">
                                    <div class="quick-stat-number text-info">${stats.total}</div>
                                    <div class="quick-stat-label">Total</div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="action-buttons mt-3 justify-content-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="controlerTatami(${tatami.id})" title="Contr√¥ler">
                                    <i class="fas fa-gamepad"></i>
                                </button>

                                ${etat === 'libre' ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="assignerCombats(${tatami.id})" title="Assigner combats">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                ` : ''}

                                ${etat === 'occup√©' ? `
                                    <button class="btn btn-sm btn-outline-warning" onclick="pauserTatami(${tatami.id})" title="Mettre en pause">
                                        <i class="fas fa-pause"></i>
                                    </button>
                                ` : ''}

                                ${etat === 'pause' ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="reprendreTatami(${tatami.id})" title="Reprendre">
                                        <i class="fas fa-play"></i>
                                    </button>
                                ` : ''}

                                <button class="btn btn-sm btn-outline-info" onclick="voirHistorique(${tatami.id})" title="Historique">
                                    <i class="fas fa-history"></i>
                                </button>

                                ${etat !== 'libre' ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="libererTatami(${tatami.id})" title="Lib√©rer">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                ` : ''}

                                <button class="btn btn-sm btn-outline-secondary" onclick="editerTatami(${tatami.id})" title="√âditer">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <button class="btn btn-sm btn-outline-danger" onclick="supprimerTatami(${tatami.id})" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
    }

    // Obtenir le combat actuel d'un tatami
    function getCombatActuel(tatami) {
        if (!tatami.combatsIds || tatami.combatsIds.length === 0) return null;

        const index = tatami.indexCombatActuel || 0;
        const combatId = tatami.combatsIds[index];
        return combats.find(c => c.id === combatId) || null;
    }

    // Calculer la progression d'un tatami
    function calculateProgression(tatami) {
        if (!tatami.combatsIds || tatami.combatsIds.length === 0) return 0;

        const index = tatami.indexCombatActuel || 0;
        return ((index + 1) / tatami.combatsIds.length) * 100;
    }

    // Obtenir les statistiques d'un tatami
    function getTatamiStats(tatami) {
        const total = tatami.combatsIds ? tatami.combatsIds.length : 0;
        const actuel = tatami.indexCombatActuel || 0;

        let termines = 0;
        if (tatami.combatsIds) {
            termines = tatami.combatsIds.slice(0, actuel).filter(id => {
                const combat = combats.find(c => c.id === id);
                return combat && combat.etat === 'termin√©';
            }).length;
        }

        return {
            total,
            termines,
            restants: Math.max(0, total - actuel)
        };
    }

    // G√©n√©rer la file d'attente des combats
    function generateCombatQueue(tatami) {
        if (!tatami.combatsIds || tatami.combatsIds.length <= 1) return [];

        const currentIndex = tatami.indexCombatActuel || 0;
        const queue = [];

        for (let i = Math.max(0, currentIndex - 1); i < Math.min(tatami.combatsIds.length, currentIndex + 4); i++) {
            const combatId = tatami.combatsIds[i];
            const combat = combats.find(c => c.id === combatId);
            if (!combat) continue;

            const isCurrent = i === currentIndex;
            const isPast = i < currentIndex;

            queue.push(`
                    <div class="combat-queue-item ${isCurrent ? 'current' : ''} ${isPast ? 'text-muted' : ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                ${isCurrent ? '<i class="fas fa-play-circle text-primary me-1"></i>' :
                isPast ? '<i class="fas fa-check-circle text-success me-1"></i>' :
                    '<i class="fas fa-clock text-muted me-1"></i>'}
                                <strong>${combat.rouge?.nom || 'Rouge'}</strong> vs
                                <strong>${combat.bleu?.nom || 'Bleu'}</strong>
                            </span>
                            <small class="text-muted">#${i + 1}</small>
                        </div>
                    </div>
                `);
        }

        return queue;
    }

    // Formatter le timer
    function formatTimer(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Mise √† jour des statistiques
    function updateStats() {
        const libres = tatamis.filter(t => t.etat === 'libre').length;
        const occupes = tatamis.filter(t => t.etat === 'occup√©').length;
        const enPause = tatamis.filter(t => t.etat === 'pause').length;

        document.getElementById('statTatamis').textContent = tatamis.length;
        document.getElementById('statLibres').textContent = libres;
        document.getElementById('statOccupes').textContent = occupes;
        document.getElementById('statEnPause').textContent = enPause;
    }

    // Mise √† jour de la s√©lection des rencontres
    function updateRencontresSelect() {
        const select = document.getElementById('rencontreSelect');
        select.innerHTML = '<option value="">-- Choisir une rencontre --</option>';

        poules.forEach(poule => {
            poule.rencontres.forEach(rencontre => {
                if (!rencontre.combatsIds || rencontre.combatsIds.length === 0) {
                    const option = document.createElement('option');
                    option.value = rencontre.id;
                    option.textContent = `${poule.nom}: ${rencontre.equipeA} vs ${rencontre.equipeB}`;
                    select.appendChild(option);
                }
            });
        });
    }

    // Mise √† jour des combats disponibles
    function updateCombatsDisponibles() {
        const container = document.getElementById('combatsDisponibles');
        const combatsLibres = combats.filter(c =>
            c.etat === 'pr√©vu' && !isAssignedToTatami(c.id)
        );

        if (combatsLibres.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">Aucun combat disponible</p>';
            return;
        }

        const html = combatsLibres.map(combat => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${combat.id}" id="combat${combat.id}">
                    <label class="form-check-label" for="combat${combat.id}">
                        <strong>${combat.rouge?.nom || 'Rouge'}</strong> vs
                        <strong>${combat.bleu?.nom || 'Bleu'}</strong>
                        <small class="text-muted d-block">${combat.rouge?.equipe || 'N/A'} vs ${combat.bleu?.equipe || 'N/A'}</small>
                    </label>
                </div>
            `).join('');

        container.innerHTML = html;
    }

    // V√©rifier si un combat est assign√© √† un tatami
    function isAssignedToTatami(combatId) {
        return tatamis.some(t => t.combatsIds && t.combatsIds.includes(combatId));
    }

    // Configuration des √©v√©nements
    function setupEventListeners() {
        // Cr√©ation/√©dition tatami
        document.getElementById('formTatami').addEventListener('submit', handleTatamiSubmit);

        // Assignation combats
        document.getElementById('formAssignation').addEventListener('submit', handleAssignationSubmit);

        // Refresh
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadData();
            showNotification('Donn√©es actualis√©es', 'info');
        });

        // Pause g√©n√©rale
        document.getElementById('pauseAllBtn').addEventListener('click', handlePauseAll);

        // Gestion des types de source
        document.querySelectorAll('input[name="sourceType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isPoule = this.value === 'poule';
                document.getElementById('sectionPoule').classList.toggle('d-none', !isPoule);
                document.getElementById('sectionCombat').classList.toggle('d-none', isPoule);
            });
        });
    }

    // Soumission formulaire tatami
    async function handleTatamiSubmit(e) {
        e.preventDefault();

        const editId = document.getElementById('tatamiEditId').value;
        const formData = {
            nom: document.getElementById('tatamiNom').value.trim(),
            description: document.getElementById('tatamiDescription').value.trim()
        };
        if (!editId && CONFIG) {
            const maxTatamis = CONFIG.tatamis.nombreMax || 10;
            if (tatamis.length >= maxTatamis) {
                showNotification(`Maximum ${maxTatamis} tatamis atteint`, 'danger');
                return;
            }
        }

        try {
            const url = editId ? `/api/tatamis/${editId}` : '/api/tatamis';
            const method = editId ? 'PATCH' : 'POST';

            const response = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalTatami'));
                modal.hide();

                showNotification(editId ? 'Tatami modifi√©' : 'Tatami cr√©√©', 'success');
                await loadData();
            } else {
                const error = await response.json();
                showNotification(error.error || 'Erreur', 'danger');
            }
        } catch (error) {
            showNotification('Erreur de connexion', 'danger');
        }
    }

    // Soumission assignation combats
    async function handleAssignationSubmit(e) {
        e.preventDefault();

        const tatamiId = parseInt(document.getElementById('assignTatamiId').value);
        const sourceType = document.querySelector('input[name="sourceType"]:checked').value;

        try {
            let response;

            if (sourceType === 'poule') {
                const rencontreId = parseInt(document.getElementById('rencontreSelect').value);
                if (!rencontreId) {
                    showNotification('Veuillez s√©lectionner une rencontre', 'warning');
                    return;
                }

                response = await fetch('/api/poules/assign-combat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rencontreId, tatamiId })
                });
            } else {
                const selectedCombats = Array.from(document.querySelectorAll('#combatsDisponibles input[type="checkbox"]:checked'))
                    .map(checkbox => parseInt(checkbox.value));

                if (selectedCombats.length === 0) {
                    showNotification('Veuillez s√©lectionner au moins un combat', 'warning');
                    return;
                }

                response = await fetch(`/api/tatamis/${tatamiId}/assigner`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ combatsIds: selectedCombats })
                });
            }

            if (response.ok) {
                const result = await response.json();
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAssignation'));
                modal.hide();

                showNotification(`Combats assign√©s avec succ√®s`, 'success');
                await loadData();
            } else {
                const error = await response.json();
                showNotification(error.error || 'Erreur lors de l\'assignation', 'danger');
            }
        } catch (error) {
            showNotification('Erreur de connexion', 'danger');
        }
    }

    // Pause g√©n√©rale
    async function handlePauseAll() {
        if (!confirm('Mettre tous les tatamis en pause ?')) return;

        try {
            const promises = tatamis
                .filter(t => t.etat === 'occup√©')
                .map(t => fetch(`/api/tatamis/${t.id}/etat`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ etat: 'pause' })
                }));

            await Promise.all(promises);
            showNotification('Tous les tatamis ont √©t√© mis en pause', 'success');
            await loadData();
        } catch (error) {
            showNotification('Erreur lors de la pause g√©n√©rale', 'danger');
        }
    }

    // Actions sur les tatamis
    function assignerCombats(tatamiId) {
        selectedTatamiId = tatamiId;
        const tatami = tatamis.find(t => t.id === tatamiId);

        document.getElementById('assignTatamiId').value = tatamiId;
        document.getElementById('assignTatamiInfo').innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-th-large text-primary me-2"></i>
                    <strong>${tatami.nom}</strong>
                    <span class="badge bg-success ms-2">Libre</span>
                </div>
            `;

        updateRencontresSelect();
        updateCombatsDisponibles();

        const modal = new bootstrap.Modal(document.getElementById('modalAssignation'));
        modal.show();
    }

    function controlerTatami(tatamiId) {
        window.location.href = `table_combat.html?tatami=${tatamiId}`;
    }

    async function pauserTatami(tatamiId) {
        try {
            await fetch(`/api/tatamis/${tatamiId}/etat`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ etat: 'pause' })
            });

            showNotification('Tatami mis en pause', 'success');
            await loadData();
        } catch (error) {
            showNotification('Erreur', 'danger');
        }
    }

    async function reprendreTatami(tatamiId) {
        try {
            await fetch(`/api/tatamis/${tatamiId}/etat`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ etat: 'occup√©' })
            });

            showNotification('Tatami repris', 'success');
            await loadData();
        } catch (error) {
            showNotification('Erreur', 'danger');
        }
    }

    async function libererTatami(tatamiId) {
        const tatami = tatamis.find(t => t.id === tatamiId);
        if (!confirm(`Lib√©rer le tatami "${tatami.nom}" ? Tous les combats assign√©s seront perdus.`)) return;

        try {
            await fetch(`/api/tatamis/${tatamiId}/liberer`, {
                method: 'PATCH'
            });

            showNotification('Tatami lib√©r√©', 'success');
            await loadData();
        } catch (error) {
            showNotification('Erreur', 'danger');
        }
    }

    function editerTatami(tatamiId) {
        const tatami = tatamis.find(t => t.id === tatamiId);
        if (!tatami) return;

        document.getElementById('modalTatamiTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Modifier le tatami';
        document.getElementById('tatamiEditId').value = tatami.id;
        document.getElementById('tatamiNom').value = tatami.nom;
        document.getElementById('tatamiDescription').value = tatami.description || '';

        const modal = new bootstrap.Modal(document.getElementById('modalTatami'));
        modal.show();
    }

    function voirHistorique(tatamiId) {
        window.location.href = `historique_tatami.html?tatami=${tatamiId}`;
    }

    async function supprimerTatami(tatamiId) {
        const tatami = tatamis.find(t => t.id === tatamiId);
        if (!tatami) return;

        // V√©rifier si le tatami a des combats en cours
        if (tatami.etat === 'occup√©' || (tatami.combatsIds && tatami.combatsIds.length > 0)) {
            if (!confirm(`Le tatami "${tatami.nom}" a des combats assign√©s. Les supprimer d√©finitivement ?`)) {
                return;
            }
        } else {
            if (!confirm(`Supprimer d√©finitivement le tatami "${tatami.nom}" ?`)) {
                return;
            }
        }

        try {
            const response = await fetch(`/api/tatamis/${tatamiId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Tatami supprim√©', 'success');
                await loadData();
            } else {
                const error = await response.json();
                showNotification(error.error || 'Erreur lors de la suppression', 'danger');
            }
        } catch (error) {
            showNotification('Erreur de connexion', 'danger');
        }
    }

    // Actions rapides FAB
    function showQuickActions() {
        const tatamisLibres = tatamis.filter(t => t.etat === 'libre');

        if (tatamisLibres.length === 0) {
            const modal = new bootstrap.Modal(document.getElementById('modalTatami'));
            modal.show();
        } else {
            assignerCombats(tatamisLibres[0].id);
        }
    }

    // WebSocket
    // refresh
    function setupAutoRefresh() {
        // Refresh automatique toutes les 3 secondes
        // Page de gestion avec actions fr√©quentes
        setInterval(() => {
            loadData();
        }, 3000);
    }

    // Notifications
    function showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 2000; min-width: 300px;';
        toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }

    // Reset des modals
    document.getElementById('modalTatami').addEventListener('hidden.bs.modal', function() {
        document.getElementById('formTatami').reset();
        document.getElementById('tatamiEditId').value = '';
        document.getElementById('modalTatamiTitle').innerHTML = '<i class="fas fa-th-large me-2"></i>Nouveau tatami';
    });

    document.getElementById('modalAssignation').addEventListener('hidden.bs.modal', function() {
        document.getElementById('formAssignation').reset();
        selectedTatamiId = null;
        document.querySelector('input[name="sourceType"][value="poule"]').checked = true;
        document.getElementById('sectionPoule').classList.remove('d-none');
        document.getElementById('sectionCombat').classList.add('d-none');
    });
</script>
</body>
</html>